<!DOCTYPE html>
<html lang="en">

<head>
    <title>Scribble.rs - Game</title>
    <meta charset="UTF-8" />
    <link rel="stylesheet" type="text/css" href="/resources/style.css" />
    <link rel="stylesheet" type="text/css" href="/resources/lobby.css" />
    <link rel="stylesheet" type="text/css" href="/resources/lobby_players.css" />
    <link rel="icon" type="image/png" href="/resources/favicon.png" />
</head>

<body>
    <noscript><span class="noscript">Hey, seems like you've disabled JavaScript.
            I get it ... but you are trying to play an interactive drawing game
            here, so you have to turn on JavaScript.</span></noscript>
    <div id="word-dialog">
        <span class="word-dialog-text">Choose a word</span>
        <div class="word-button-container">
            <button id="word-button-zero" class="word-button" onclick="chooseWord(0)">Placeholder</button>
            <button id="word-button-one" class="word-button" onclick="chooseWord(1)">Placeholder</button>
            <button id="word-button-two" class="word-button" onclick="chooseWord(2)">Placeholder</button>
        </div>
    </div>
    <div class="content-wrapper">
        <div class="lobby-layout">
            <div class="top-left-container">
                <span id="rounds">Round {{.Round}} of {{.Rounds}}</span>
                <label for="sound-toggle">
                    <input class="custom-check-or-radio sound-toggle-input" type="checkbox" name="sound-toggle"
                        onchange="toggleSound()" />
                    <span id="sound-toggle-label"></span>
                </label>
            </div>
            <div id="word-container">
                {{template "word" .WordHints}}
            </div>
            <span id="time-left">Time Left: âˆž</span>

            <div id="player-container">
                {{template "players" .Players}}
            </div>
            <div>
                <canvas id="drawing-board" width="1100" height="600"></canvas>
                <div style="display: flex; flex-direction: row;">
                    <input type="color" id="color-picker" onchange="setColor()" value="#000000">
                    <div class="color-button-container">
                        <div class="color-button-row">
                            <button class="color-button" style="background-color: #ffffff"
                                onclick="setColor('#ffffff')"></button>
                            <button class="color-button" style="background-color: #c1c1c1"
                                onclick="setColor('#c1c1c1')"></button>
                            <button class="color-button" style="background-color: #ef130b"
                                onclick="setColor('#ef130b')"></button>
                            <button class="color-button" style="background-color: #ff7100"
                                onclick="setColor('#ff7100')"></button>
                            <button class="color-button" style="background-color: #ffe400"
                                onclick="setColor('#ffe400')"></button>
                            <button class="color-button" style="background-color: #00cc00"
                                onclick="setColor('#00cc00')"></button>
                            <button class="color-button" style="background-color: #00b2ff"
                                onclick="setColor('#00b2ff')"></button>
                            <button class="color-button" style="background-color: #231fd3"
                                onclick="setColor('#231fd3')"></button>
                            <button class="color-button" style="background-color: #a300ba"
                                onclick="setColor('#a300ba')"></button>
                            <button class="color-button" style="background-color: #d37caa"
                                onclick="setColor('#d37caa')"></button>
                            <button class="color-button" style="background-color: #a0522d"
                                onclick="setColor('#a0522d')"></button>
                        </div>
                        <div class="color-button-row">
                            <button class="color-button" style="background-color: #000000"
                                onclick="setColor('#000000')"></button>
                            <button class="color-button" style="background-color: #4c4c4c"
                                onclick="setColor('#4c4c4c')"></button>
                            <button class="color-button" style="background-color: #740b07"
                                onclick="setColor('#740b07')"></button>
                            <button class="color-button" style="background-color: #c23800"
                                onclick="setColor('#c23800')"></button>
                            <button class="color-button" style="background-color: #e8a200"
                                onclick="setColor('#e8a200')"></button>
                            <button class="color-button" style="background-color: #005510"
                                onclick="setColor('#005510')"></button>
                            <button class="color-button" style="background-color: #00569e"
                                onclick="setColor('#00569e')"></button>
                            <button class="color-button" style="background-color: #0e0865"
                                onclick="setColor('#0e0865')"></button>
                            <button class="color-button" style="background-color: #550069"
                                onclick="setColor('#550069')"></button>
                            <button class="color-button" style="background-color: #a75574"
                                onclick="setColor('#a75574')"></button>
                            <button class="color-button" style="background-color: #63300d"
                                onclick="setColor('#63300d')"></button>
                        </div>
                    </div>
                    <label for="size2">
                        <input id="size2" class="custom-check-or-radio line-width-button" onchange="setLineWidth(2)"
                            type="radio" name="line-width" checked>
                        <div class="line-width-button-content">
                            <div class="dot size-2"></div>
                        </div>
                    </label>
                    <label for="size5">
                        <input id="size5" class="custom-check-or-radio line-width-button" onchange="setLineWidth(5)"
                            type="radio" name="line-width">
                        <div class="line-width-button-content">
                            <div class="dot size-5"></div>
                        </div>
                    </label>
                    <label for="size15">
                        <input id="size15" class="custom-check-or-radio line-width-button" onchange="setLineWidth(15)"
                            type="radio" name="line-width">
                        <div class="line-width-button-content">
                            <div class="dot size-15"></div>
                        </div>
                    </label>
                    <label for="size30">
                        <input id="size30" class="custom-check-or-radio line-width-button" onchange="setLineWidth(30)"
                            type="radio" name="line-width">
                        <div class="line-width-button-content">
                            <div class="dot size-30"></div>
                        </div>
                    </label>
                    <label for="size40">
                        <input id="size40" class="custom-check-or-radio line-width-button" onchange="setLineWidth(40)"
                            type="radio" name="line-width">
                        <div class="line-width-button-content">
                            <div class="dot size-40"></div>
                        </div>
                    </label>
                    <button class="canvas-button" style="font-size: 2rem;" onclick="clearCanvas()">ðŸ—‘</button>
                </div>
            </div>
            <div class="chat">
                <div id="message-container"></div>
                <form class="message-input-form" onsubmit="return sendMessage()">
                    <input id="message-input" type="text" autocomplete="off" placeholder="Type your message" />
                </form>
            </div>
        </div>
    </div>

    {{template "footer"}}

    <script>
        function httpGetAsync(theUrl, callback) {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", theUrl, true);
            xhr.onload = function (e) {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        callback(xhr);
                    } else {
                        console.error(xhr.statusText);
                    }
                }
            };
            xhr.onerror = function (e) {
                console.error(xhr.statusText);
            };
            xhr.send(null);
        }

        console.log("Attempting Connection...");
        const socket = new WebSocket("ws://" + location.hostname + ":{{.Port}}/ws?id={{.LobbyID}}");

        const messageInput = document.getElementById("message-input");
        const playerContainer = document.getElementById("player-container");
        const wordContainer = document.getElementById("word-container");
        const messageContainer = document.getElementById("message-container");
        const roundsSpan = document.getElementById("rounds");
        const timeLeft = document.getElementById("time-left");
        const drawingBoard = document.getElementById("drawing-board");
        const context = drawingBoard.getContext("2d");
        context.lineJoin = "round"
        const colorPicker = document.getElementById("color-picker");
        const lineWidthChooser = document.getElementById("line-width");
        const wordDialog = document.getElementById("word-dialog");
        const wordButtonZero = document.getElementById("word-button-zero");
        const wordButtonOne = document.getElementById("word-button-one");
        const wordButtonTwo = document.getElementById("word-button-two");

        const noSoundIcon = "ðŸ”‡"
        const soundIcon = "ðŸ”Š"
        const soundToggleLabel = document.getElementById("sound-toggle-label");
        var sound;
        if (localStorage.getItem("sound") === "false") {
            sound = false;
            soundToggleLabel.innerText = noSoundIcon;
        } else {
            sound = true;
            soundToggleLabel.innerText = soundIcon;
        }

        function toggleSound() {
            if (sound) {
                localStorage.setItem("sound", "false")
                sound = false;
                soundToggleLabel.innerText = noSoundIcon;
            } else {
                localStorage.setItem("sound", "true")
                sound = true;
                soundToggleLabel.innerText = soundIcon;
            }
        }

        var allowDrawing = false;
        var localColor = "black";
        var localLineWidth;
        setLineWidth(2);

        function setColor(value) {
            if (value === undefined) {
                localColor = colorPicker.value;
            } else {
                localColor = value;
                colorPicker.value = value;
            }
        }

        function setLineWidth(value) {
            drawingBoard.style.cursor = "url('data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" version=\"1.1\" width=\"" + (value + 2) + "\" height=\"" + (value + 2) + "\"><circle cx=\"" + (value / 2) + "\" cy=\"" + (value / 2) + "\" r=\"" + (value / 2) + "\" style=\"fill: black;\"/></svg>') " + (value / 2) + " " + (value / 2) + ", auto";
            localLineWidth = value
        }

        function clearCanvas() {
            socket.send(JSON.stringify({ Type: "clear-drawing-board" }));
        }

        function fill() {
            var pixelStack = [[e.offsetX, e.offsetY]];

            while (pixelStack.length) {
                var newPos, x, y, pixelPos, reachLeft, reachRight;
                newPos = pixelStack.pop();
                x = newPos[0];
                y = newPos[1];

                pixelPos = (y * canvasWidth + x) * 4;
                while (y-- >= drawingBoundTop && matchStartColor(pixelPos)) {
                    pixelPos -= canvasWidth * 4;
                }
                pixelPos += canvasWidth * 4;
                ++y;
                reachLeft = false;
                reachRight = false;
                while (y++ < canvasHeight - 1 && matchStartColor(pixelPos)) {
                    colorPixel(pixelPos);

                    if (x > 0) {
                        if (matchStartColor(pixelPos - 4)) {
                            if (!reachLeft) {
                                pixelStack.push([x - 1, y]);
                                reachLeft = true;
                            }
                        }
                        else if (reachLeft) {
                            reachLeft = false;
                        }
                    }

                    if (x < canvasWidth - 1) {
                        if (matchStartColor(pixelPos + 4)) {
                            if (!reachRight) {
                                pixelStack.push([x + 1, y]);
                                reachRight = true;
                            }
                        }
                        else if (reachRight) {
                            reachRight = false;
                        }
                    }

                    pixelPos += canvasWidth * 4;
                }
            }
            context.putImageData(colorLayer, 0, 0);
        }

        function matchStartColor(pixelPos) {
            var r = colorLayer.data[pixelPos];
            var g = colorLayer.data[pixelPos + 1];
            var b = colorLayer.data[pixelPos + 2];

            return (r == startR && g == startG && b == startB);
        }

        function colorPixel(pixelPos) {
            var d = document.createElement("div");
            d.style.color = localColor;
            var colorProperty = window.getComputedStyle(d, null).getPropertyValue("color");
            var rgb = colorProperty.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);

            colorLayer.data[pixelPos] = rgb[1];
            colorLayer.data[pixelPos + 1] = rgb[2];
            colorLayer.data[pixelPos + 2] = rgb[3];
            colorLayer.data[pixelPos + 3] = 255;
        }

        const sendMessage = () => {
            socket.send(JSON.stringify({ Type: "message", Data: messageInput.value }));
            messageInput.value = "";

            // Necessary in order to keep the page from submitting.
            return false;
        }

        function chooseWord(index) {
            socket.send(JSON.stringify({ Type: "choose-word", Data: index }));
            wordDialog.style.visibility = "hidden";
        }

        function onClickKickButton(playerId) {
            socket.send(JSON.stringify({ Type: "kick-vote", Data: playerId }));
        }

        new MutationObserver(
            () => { messageContainer.scrollTop = messageContainer.scrollHeight; }
        ).observe(messageContainer, { attributes: false, childList: true, subtree: false });

        socket.onopen = () => {
            console.log("Successfully Connected");
        };

        socket.onmessage = event => {
            var parsed = JSON.parse(event.data);
            if (parsed.Type === "update-players") {
                httpGetAsync("/lobby/players?id={{.LobbyID}}", response => {
                    playerContainer.innerHTML = response.responseText;
                });
            } else if (parsed.Type === "correct-guess") {
                if (sound) {
                    var audio = new Audio('/resources/plop.wav');
                    audio.type = 'audio/wav';

                    audio.play();
                }

                httpGetAsync("/lobby/players?id={{.LobbyID}}", response => {
                    playerContainer.innerHTML = response.responseText;
                });
            } else if (parsed.Type === "update-wordhint") {
                httpGetAsync("/lobby/wordhint?id={{.LobbyID}}", response => {
                    wordContainer.innerHTML = response.responseText;
                });
            } else if (parsed.Type === "update-rounds") {
                httpGetAsync("/lobby/rounds?id={{.LobbyID}}", response => {
                    roundsSpan.innerText = response.responseText;
                });
            } else if (parsed.Type === "message") {
                messageContainer.innerHTML += `<div class="message">
                        <span class="chat-name">` + parsed.Data.Author + `</span>
                        <span class="message-content">` + parsed.Data.Content + `</span>
                    </div>`;
            } else if (parsed.Type === "system-message") {
                messageContainer.innerHTML += `<div class="message system-message">
                        <span class="chat-name">System</span>
                        <span class="message-content">` + parsed.Data + `</span>
                    </div>`;
            } else if (parsed.Type === "non-guessing-player-message") {
                messageContainer.innerHTML += `<div class="non-guessing-player-message">
                        <span class="chat-name">` + parsed.Data.Author + `</span>
                        <span class="message-content">` + parsed.Data.Content + `</span>
                    </div>`;
            } else if (parsed.Type === "persist-username") {
                //TODO GMT date for consistency?
                document.cookie = "username=" + parsed.Data + ";expires=Tue, 19 Jan 2038 03:14:07 UTC;path=/;samesite=strict";
            } else if (parsed.Type === "reset-username") {
                document.cookie = "username=; expires=Thu, 01 Jan 1970 00:00:00 GMT";
            } else if (parsed.Type === "pixel") {
                drawLine(context, parsed.Data.FromX, parsed.Data.FromY, parsed.Data.ToX, parsed.Data.ToY, parsed.Data.Color, parsed.Data.LineWidth);
            } else if (parsed.Type === "clear-drawing-board") {
                context.clearRect(0, 0, drawingBoard.width, drawingBoard.height);
            } else if (parsed.Type === "next-turn") {
                if (sound) {
                    var audio = new Audio('/resources/end-turn.wav');
                    audio.type = 'audio/wav';

                    audio.play();
                }

                context.clearRect(0, 0, drawingBoard.width, drawingBoard.height);

                allowDrawing = false;
            } else if (parsed.Type === "your-turn") {
                allowDrawing = true;
            } else if (parsed.Type === "update-time") {
                timeLeft.innerText = "Time Left: " + parsed.Data;
            } else if (parsed.Type === "prompt-words") {
                if (sound) {
                    var audio = new Audio('/resources/your-turn.wav');
                    audio.type = 'audio/wav';

                    audio.play();
                }

                wordButtonZero.textContent = parsed.Data[0];
                wordButtonOne.textContent = parsed.Data[1];
                wordButtonTwo.textContent = parsed.Data[2];
                wordDialog.style.visibility = "visible";
            }
        };

        socket.onclose = event => {
            console.log("Socket Closed Connection: ", event);
        };

        socket.onerror = error => {
            console.log("Socket Error: ", error);
        };

        var isDrawing = false;
        var x = 0;
        var y = 0;

        drawingBoard.onmouseleave = function (e) {
            isDrawing = false;
        }

        drawingBoard.onmousedown = function (e) {
            if (allowDrawing) {
                x = e.offsetX;
                y = e.offsetY;
                isDrawing = true;
            }
        };

        drawingBoard.onmousemove = function (e) {
            if (allowDrawing && isDrawing === true) {
                drawLineAndSendEvent(context, x, y, e.offsetX, e.offsetY, localColor, localLineWidth);
                x = e.offsetX;
                y = e.offsetY;
            }
        };

        drawingBoard.onmouseup = function (e) {
            if (isDrawing === true) {
                isDrawing = false;
            }
        };

        var isMouseDown = false;
        document.onmousedown = function () {
            isMouseDown = true;
        };
        document.onmouseup = function () {
            isMouseDown = false;
        };

        drawingBoard.onmouseenter = function (e) {
            if (isMouseDown && allowDrawing) {
                x = e.offsetX;
                y = e.offsetY;
                isDrawing = true;
            }
        };

        drawingBoard.onclick = function (e) {
            if (allowDrawing) {
                drawLineAndSendEvent(context, e.offsetX, e.offsetY, e.offsetX, e.offsetY, localColor, localLineWidth);
                isDrawing = false;
            }
        };

        function drawLine(context, x1, y1, x2, y2, color, lineWidth) {
            if (x1 === x2 && y1 === y2) {
                context.beginPath();
                context.fillStyle = color;
                context.arc(x1, y2, lineWidth / 2, 0, 2 * Math.PI);
                context.closePath();
                context.fill();
            } else {
                context.beginPath();
                context.strokeStyle = color;
                context.lineWidth = lineWidth;

                context.moveTo(x1, y1);
                context.lineTo(x2, y2);
                context.closePath();
                context.stroke();
            }
        }

        function drawLineAndSendEvent(context, x1, y1, x2, y2, color, lineWidth) {
            drawLine(context, x1, y1, x2, y2, color, lineWidth)
            socket.send(JSON.stringify({
                Type: "pixel", Data: {
                    FromX: x1,
                    FromY: y1,
                    ToX: x2,
                    ToY: y2,
                    Color: color,
                    LineWidth: lineWidth,
                }
            }));
        }
    </script>
</body>

</html>